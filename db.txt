-- Create Table for Site Configuration
CREATE TABLE site_config (
    key TEXT PRIMARY KEY,
    value TEXT
);

-- Insert Default Config
INSERT INTO site_config (key, value) VALUES 
-- General
('brand_name', 'NeonMarket'),
('brand_logo_url', ''), -- Logo URL
('brand_color_primary', 'blue'), -- Future use

-- SEO Settings
('seo_site_title', 'NeonMarket - Digital Assets Store'),
('seo_description', 'Pusat belanja aset digital, template, dan tool kreatif terbaik. Download gratis dan premium sekarang.'),
('seo_keywords', 'digital assets, ui kit, presentation template, fonts, 3d icons, neon design, marketplace indonesia'),
('seo_author', 'NeonMarket Team'),
('seo_google_verification', ''), -- Google Search Console Code
('seo_bing_verification', ''), -- Bing Webmaster Code
('seo_yandex_verification', ''), -- Yandex Verification
('seo_og_image', ''), -- Default Social Share Image URL

-- Hero Section
('hero_badge_text', 'Digital Products & Assets'),
('hero_title', 'Level Up Your \n"Digital Game"'),
('hero_subtitle', 'Temukan aset digital premium, template, dan tool gratis untuk mempercepat workflow kreatifmu. Kualitas tinggi, harga terjangkau.'),
('hero_btn_primary', 'Lihat Produk'),
('hero_btn_secondary', 'Ambil Gratisan'),
('hero_image_url', ''),

-- Products Section
('products_title', 'Produk "Premium"'),
('products_subtitle', 'Investasi terbaik untuk project masa depanmu.'),

-- Freebies Section
('freebies_badge_text', 'Free Resources'),
('freebies_title', 'Ambil "Gratisan"'),
('freebies_subtitle', 'Jangan lewatkan resource gratis berkualitas untuk mendukung project kreatifmu.'),

-- WhatsApp Section
('wa_section_title', 'Join Komunitas \n"Exclusive"'),
('wa_section_desc', 'Dapatkan info promo, update produk terbaru, dan tips trik seputar desain langsung ke WhatsApp-mu. 100% Bebas Spam.'),
('wa_btn_text', 'Gabung Channel WA'),
('wa_link', 'https://whatsapp.com/channel/'),

-- Product Detail
('product_badge_text', 'Premium Asset'),

-- Product Detail Features
('detail_feature_1_title', 'Secure Payment'),
('detail_feature_1_desc', 'Transaksi aman 100%'),
('detail_feature_2_title', 'Instant Delivery'),
('detail_feature_2_desc', 'Langsung akses file'),

-- Footer
('footer_text', 'NeonMarket. All rights reserved. Built with React & Supabase.'),

-- Social Proof / Fake Purchase Notification
('fake_purchase_enabled', 'true'), -- ON/OFF Feature
('fake_purchase_delay', '20'), -- Delay in seconds
('fake_purchase_names', 'Budi Santoso\nSiti Aminah\nRizky Ramadhan\nDewi Lestari\nJoko Anwar\nPutri Ayudya\nKevin Sanjaya\nAnisa Rahma'),

-- Pop-up Promo/Notifikasi (NEW)
('popup_enabled', 'false'), -- Enable/Disable popup
('popup_image_url', ''), -- URL gambar popup (optional)
('popup_text', ''), -- Teks popup (alternatif gambar)
('popup_link', ''), -- Optional link ketika gambar/teks diklik
('popup_delay', '30'), -- Delay dalam detik sebelum popup muncul lagi
('popup_repeat_mode', 'false'), -- true = repeat, false = sekali tampil

-- Store Operating Hours (NEW)
('store_enabled', 'true'), -- Manual override: 'true' = open, 'false' = closed
('store_auto_schedule', 'false'), -- Enable auto schedule based on time
('store_hours_open', '09:00'), -- Jam buka (24h format)
('store_hours_close', '21:00'), -- Jam tutup
('store_days', '1,2,3,4,5,6,7'), -- Hari buka (1=Senin, 7=Minggu)
('store_closed_message', 'Maaf, toko sedang tutup. Silakan kembali saat jam operasional.'); -- Custom closed message

-- Create Products Table
CREATE TABLE products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    content TEXT, -- Detail description for product page
    price NUMERIC NOT NULL,
    original_price NUMERIC, -- Harga Coret (Optional)
    image_url TEXT,
    link TEXT NOT NULL,
    button_text TEXT DEFAULT 'Beli Sekarang', -- Custom button text
    payment_type TEXT DEFAULT 'AUTO', -- 'AUTO' | 'MANUAL'
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert Sample Products
INSERT INTO products (title, description, content, price, original_price, image_url, link, button_text) VALUES 
(
    'Neon Cyber Deck', 
    'Template premium untuk presentasi futuristik.', 
    'Dapatkan akses ke 50+ slide presentasi dengan gaya Cyberpunk yang memukau. Cocok untuk pitch deck startup teknologi atau portofolio desain. \n\nFitur:\n- 50+ Unique Slides\n- 16:9 Aspect Ratio\n- Fully Editable\n- Free Fonts Used',
    150000,
    300000, -- Diskon 50%
    'https://picsum.photos/seed/cyber1/800/600', 
    'https://gumroad.com/example',
    'Beli Template'
),
(
    'Dark UI Kit', 
    'Kumpulan komponen UI dark mode untuk React.',
    'Percepat development frontend Anda dengan Dark UI Kit. Terintegrasi penuh dengan Tailwind CSS dan React.\n\nIncludes:\n- Buttons, Cards, Forms\n- Navigation Bars\n- Charts & Graphs', 
    299000,
    NULL, -- Tidak ada diskon
    'https://picsum.photos/seed/ui/800/600', 
    'https://gumroad.com/example',
    'Download Kit'
),
(
    'Glitch Font Pack', 
    '5 Font gaya glitch unik untuk desain poster.',
    'Font pack eksklusif dengan efek glitch yang dapat diedit. Format OTF dan TTF tersedia.',
    75000, 
    100000,
    'https://picsum.photos/seed/font/800/600', 
    'https://gumroad.com/example',
    'Beli Font'
),
(
    '3D Icons Bundle', 
    '100+ Ikon 3D dengan warna neon.',
    'Ikon 3D resolusi tinggi (4000x4000px) dengan transparansi. Sempurna untuk landing page modern.',
    199000, 
    250000,
    'https://picsum.photos/seed/3d/800/600', 
    'https://gumroad.com/example',
    'Akses Bundle'
);

-- Create Freebies Table
CREATE TABLE freebies (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    image_url TEXT,
    link TEXT,
    button_text TEXT DEFAULT 'Download Now' -- Custom button text (NEW)
);

-- Insert Sample Freebies
INSERT INTO freebies (title, description, image_url, link, button_text) VALUES 
('Wallpaper Pack 4K', '10 Wallpaper abstrak neon kualitas tinggi.', 'https://picsum.photos/seed/wall/400/300', '#', 'Download Wallpaper'),
('Figma Wireframe', 'Starter kit untuk wireframing cepat.', 'https://picsum.photos/seed/figma/400/300', '#', 'Get Figma File');

-- Create Social Links Table
CREATE TABLE social_links (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    label TEXT NOT NULL, -- e.g., "Instagram", "TikTok"
    url TEXT NOT NULL
);

-- Insert Default Social Links
INSERT INTO social_links (label, url) VALUES
('Instagram', 'https://instagram.com'),
('Twitter', 'https://twitter.com'),
('Email', 'mailto:hello@example.com');

-- Set up Row Level Security (RLS)
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE freebies ENABLE ROW LEVEL SECURITY;
ALTER TABLE site_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE social_links ENABLE ROW LEVEL SECURITY;

-- Allow public read access
CREATE POLICY "Public read products" ON products FOR SELECT USING (true);
CREATE POLICY "Public read freebies" ON freebies FOR SELECT USING (true);
CREATE POLICY "Public read config" ON site_config FOR SELECT USING (true);
CREATE POLICY "Public read social_links" ON social_links FOR SELECT USING (true);

-- Allow full access for anon (CAUTION: Production apps should use authenticated roles)
CREATE POLICY "Anon full access products" ON products FOR ALL USING (true);
CREATE POLICY "Anon full access freebies" ON freebies FOR ALL USING (true);
CREATE POLICY "Anon full access config" ON site_config FOR ALL USING (true);
CREATE POLICY "Anon full access social_links" ON social_links FOR ALL USING (true);

-- ==========================================
-- STORAGE SETUP (For Image Uploads)
-- ==========================================

-- 1. Create a public bucket named 'images'
INSERT INTO storage.buckets (id, name, public) 
VALUES ('images', 'images', true)
ON CONFLICT (id) DO NOTHING;

-- 2. Set up Storage Policies to allow public viewing and anonymous uploads
-- Allow public access to view images
CREATE POLICY "Public Access Images" ON storage.objects FOR SELECT USING ( bucket_id = 'images' );

-- Allow anonymous uploads (CAUTION: In production, restrict this to authenticated admins)
CREATE POLICY "Anon Upload Images" ON storage.objects FOR INSERT WITH CHECK ( bucket_id = 'images' );
CREATE POLICY "Anon Update Images" ON storage.objects FOR UPDATE USING ( bucket_id = 'images' );
CREATE POLICY "Anon Delete Images" ON storage.objects FOR DELETE USING ( bucket_id = 'images' );

-- ==========================================
-- NEW FEATURES: STOCK & PAYMENT SYSTEM
-- ==========================================

-- 1. Product Stocks Table
CREATE TABLE product_stocks (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id BIGINT REFERENCES products(id) ON DELETE CASCADE,
    content TEXT NOT NULL, -- The actually secret content (link/text)
    is_claimed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. Transactions Table
CREATE TABLE transactions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    ref_id TEXT, -- Reference ID from Payment Gateway
    product_id BIGINT REFERENCES products(id),
    product_title TEXT, -- Snapshot in case product is deleted
    price NUMERIC,
    buyer_email TEXT,
    buyer_phone TEXT,
    payment_method TEXT, -- 'MANUAL' or 'ATLANTIC_QRIS'
    status TEXT DEFAULT 'PENDING', -- PENDING, PAID, FAILED
    payment_url TEXT, -- QRIS Image URL or Payment Page
    stock_content TEXT -- Copy of stock content delivered to user
);

-- 3. Payment Configuration (Secure Table)
CREATE TABLE payment_config (
    key TEXT PRIMARY KEY,
    value TEXT
);

-- Insert Default Payment Config
INSERT INTO payment_config (key, value) VALUES 
('atlantic_api_key', '');


-- ============================================================================
-- IMPORTANT: RUN THIS MIGRATION IN SUPABASE SQL EDITOR
-- ============================================================================
-- Required for Atlantic Payment Integration
-- Add columns: fee, atlantic_id, get_balance (merchant receives)
-- ============================================================================

ALTER TABLE transactions ADD COLUMN IF NOT EXISTS fee NUMERIC DEFAULT 0;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS atlantic_id TEXT;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS get_balance NUMERIC DEFAULT 0;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS unique_code INTEGER DEFAULT 0;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS invoice_url TEXT;
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS reserved_stock_id BIGINT REFERENCES product_stocks(id);
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS expired_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE products ADD COLUMN IF NOT EXISTS payment_type TEXT DEFAULT 'AUTO';
ALTER TABLE products ADD COLUMN IF NOT EXISTS button_text TEXT DEFAULT 'Beli Sekarang';
ALTER TABLE products ADD COLUMN IF NOT EXISTS sold_count INTEGER DEFAULT 0;
ALTER TABLE products ADD COLUMN IF NOT EXISTS manual_stock INTEGER DEFAULT 100;

-- RLS Policies for New Tables
ALTER TABLE product_stocks ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_config ENABLE ROW LEVEL SECURITY;

-- Stocks: Admin full access, Anon no access (handled via function/admin check)
CREATE POLICY "Admin full access stocks" ON product_stocks FOR ALL USING (true);

-- Transactions: Admin full access, Users can insert (create order) and read their own (by ID/Email - logic in app)
CREATE POLICY "Public create transactions" ON transactions FOR INSERT WITH CHECK (true);
CREATE POLICY "Public read transactions" ON transactions FOR SELECT USING (true); -- Simplified for demo, ideally restricted by ID/Email

-- Payment Config: Admin only read/write
CREATE POLICY "Admin full access payment_config" ON payment_config FOR ALL USING (true);

-- REQUIRED FOR USER CANCELLATION (Run these if users can't cancel):
CREATE POLICY "Public update transactions" ON transactions FOR UPDATE USING (true);
CREATE POLICY "Public update stocks" ON product_stocks FOR UPDATE USING (true);

-- ============================================================================
-- 2024-0X-XX UPDATE: Add Quantity & Multi-Item Support
-- ============================================================================

-- 1. Add 'quantity' column to transactions table (default to 1)
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS quantity INTEGER DEFAULT 1;

-- 2. Add 'reserved_stock_ids' column (Array of Numbers) for multi-item support
ALTER TABLE transactions ADD COLUMN IF NOT EXISTS reserved_stock_ids BIGINT[];